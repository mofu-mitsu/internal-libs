name: Bluesky Repost Bot
on:
  schedule:
    - cron: '0 */6 * * *'  # 6ÊôÇÈñì„Åî„Å®
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å
concurrency:
  group: bluesky-repost-bot
  cancel-in-progress: true
jobs:
  run-repost-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write  # „Ç≥„Éü„ÉÉ„ÉàÊ®©Èôê
      actions: write   # ActionsÊìç‰Ωú
    steps:
      - name: „É™„Éù„Ç∏„Éà„É™„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Python„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
      - name: „É≠„Ç∞„Çí‰øùÂ≠ò
        run: |
          mkdir -p logs
          echo "Starting üöñ „Çä„ÅΩ„Çä„ÇìBot at $(date)" >> logs/repost_bot.log
      - name: „Çä„ÅΩ„Çä„ÇìBot„ÇíÂÆüË°å
        env:
          HANDLE: ${{ secrets.HANDLE }}
          APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        run: |
          python repost_bot.py | tee -a logs/repost_bot.log
      - name: „É™„Éù„Çπ„ÉàÂ±•Ê≠¥„Çí„Ç≥„Éü„ÉÉ„Éà
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git checkout -b repost-history || git checkout repost-history
          if [ -f reposted_uris.txt ]; then
            git add reposted_uris.txt
            git commit -m "Update reposted_uris.txt" || echo "No changes to commit"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/mofu-mitsu/mirin_bot_once.git repost-history --force
          else
            echo "No reposted_uris.txt found, creating empty file"
            touch reposted_uris.txt
            git add reposted_uris.txt
            git commit -m "Create empty reposted_uris.txt" || echo "No changes to commit"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/mofu-mitsu/mirin_bot_once.git repost-history --force
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: „É≠„Ç∞„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repost-bot-logs
          path: logs/repost_bot.log