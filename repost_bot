# repost_bot.py
from atproto import Client
import time
import os
import random
from dotenv import load_dotenv

# ------------------------------
# â˜… ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ: ãƒªãƒã‚¹ãƒˆå¯¾è±¡ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
# ------------------------------
# ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‚’ç·¨é›†ã—ã¦ã€ãƒªãƒã‚¹ãƒˆã™ã‚‹æŠ•ç¨¿ã‚’ã‚«ã‚¹ã‚¿ãƒ ï¼
# ä¾‹: å¿ãŸã‚“Botãªã‚‰ ['#å¿è€…', '#ä¾'], ['å¿è€…', 'ä¾']
TARGET_HASHTAGS = [
    '#ã‚ªãƒªã‚­ãƒ£ãƒ©ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼', '#ãµã‚ãµã‚ç›¸æ€§è¨ºæ–­', '#æŽ¨ã—ã‚­ãƒ£ãƒ©ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼', '#ã‚‚ãµã¿ã¤å·¥æˆ¿', '#ã¿ã‚Šã‚“ã¦ã‚ƒ', '#ã¿ã‚Šã‚“ã¦ã‚ƒbot',
]
TARGET_KEYWORDS = [
    'ã‚ªãƒªã‚­ãƒ£ãƒ©ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼', 'ãµã‚ãµã‚ç›¸æ€§è¨ºæ–­', 'æŽ¨ã—ã‚­ãƒ£ãƒ©ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼', 'ã‚‚ãµã¿ã¤å·¥æˆ¿', 'ã¿ã‚Šã‚“ã¦ã‚ƒ', 'ã¿ã‚Šã‚“ã¦ã‚ƒbot',
]

# ------------------------------
# â˜… ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆ: å¼•ç”¨ãƒªãƒã‚¹ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆ
# ------------------------------
# å¼•ç”¨ãƒªãƒã‚¹ãƒˆæ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ã§é¸ã°ã‚Œã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ
REPOST_COMMENTS = [
    "ã‚­ãƒ©ã‚­ãƒ©âœ¨ ã¿ã‚Šã‚“ã¦ã‚ƒæŽ¨ã—ãªã®ã£â™¡",
    "ãµwaãµwaã€œï¼ã“ã‚Œè¶…ã‹ã‚ã„ã„ãªã®ã£â™ª",
    "ãˆã¸ã€œâ™ª å›ã®æŠ•ç¨¿ã€ã‚ã£ã¡ã‚ƒå¥½ãã ã‚ˆâ™¡",
    "ãŽã‚…ã£â™¡ ã“ã®ãƒã‚¹ãƒˆã€ã¿ã‚Šã‚“ã¦ã‚ƒã®ãŠæ°—ã«å…¥ã‚Šï¼",
    "ã“ã‚Œè¦‹ã¦ãƒ‹ã‚³ãƒ‹ã‚³ã—ã¡ã‚ƒã£ãŸãã€œðŸŽ€>  Ì« <ðŸŽ€",
    "ã‚­ãƒŸã®ã‚»ãƒ³ã‚¹ã€ãƒãƒãƒãƒã«å…‰ã£ã¦ã‚‹ã…âœ¨âœ¨",
    "ã ã„ã™ãã£â™¡ ã‚‚ã£ã‹ã„èª­ã‚“ã˜ã‚ƒã£ãŸã®ã£ï¼",
    "ãŽã‚ƒã€œã€œï¼æœ€é«˜ã™ãŽã¦ã¿ã‚Šã‚“ã¦ã‚ƒæ˜‡å¤©âœï¸â™¡",
    "å°Šã™ãŽã¦èªžå½™åŠ›ã¨ã‘ãŸ...ãµã«ã‚ƒã‚ã€œã€œã€œã€œ(ê’ªê’³ê’ª )",
    "ã“ã‚Œã€ã¿ã‚Šã‚“ã¦ã‚ƒã®å¿ƒã«ãšãã‚…ã‚“ã ã‚ˆ(Ë†â©Œâ©Šâ©ŒË†)ðŸ’˜â˜…",
]

# âœ… ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ï¼ˆ.env ã¾ãŸã¯ Secretsï¼‰
load_dotenv()
HANDLE = os.getenv("HANDLE") or exit("âŒ HANDLEãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
APP_PASSWORD = os.getenv("APP_PASSWORD") or exit("âŒ APP_PASSWORDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

# ðŸ” Blueskyã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
client = Client()
try:
    client.login(HANDLE, APP_PASSWORD)
    print("âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ")
    self_did = client.me.did
except Exception as e:
    print(f"âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: {e}")
    exit(1)

# ðŸ“œ ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ãƒªãƒã‚¹ãƒˆå±¥æ­´ï¼ˆä¿é™ºï¼‰
reposted_uris = set()
# çµ±è¨ˆç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
repost_count = 0
skip_count = 0
error_count = 0

def repost_if_needed(uri, cid, text, post, is_quote=False):
    """æŠ•ç¨¿ã‚’ãƒªãƒã‚¹ãƒˆï¼ˆå¼•ç”¨ãƒªãƒã‚¹ãƒˆå¯ï¼‰ã€‚ã™ã§ã«ãƒªãƒã‚¹ãƒˆæ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—"""
    global repost_count, skip_count, error_count
    viewer_repost = post.viewer.repost if hasattr(post, 'viewer') and hasattr(post.viewer, 'repost') else None
    if viewer_repost:
        print(f"â© ãƒªãƒã‚¹ãƒˆæ¸ˆã¿ã‚¹ã‚­ãƒƒãƒ—: {text[:40]}")
        skip_count += 1
        return
    if uri in reposted_uris:
        print(f"â© ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã‚¹ã‚­ãƒƒãƒ—: {text[:40]}")
        skip_count += 1
        return
    try:
        if is_quote:
            # å¼•ç”¨ãƒªãƒã‚¹ãƒˆ
            comment = random.choice(REPOST_COMMENTS)
            client.app.bsky.feed.post.create(
                repo=client.me.did,
                record={
                    "text": comment,
                    "embed": {
                        "$type": "app.bsky.embed.record",
                        "record": {"uri": uri, "cid": cid}
                    },
                    "createdAt": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime())
                }
            )
            print(f"ðŸ“¬ å¼•ç”¨ãƒªãƒã‚¹ãƒˆ: {comment[:40]} (å…ƒ: {text[:40]})")
        else:
            # é€šå¸¸ãƒªãƒã‚¹ãƒˆ
            client.app.bsky.feed.repost.create_repost(
                {
                    "repo": client.me.did,
                    "subject": {"uri": uri, "cid": cid},
                    "createdAt": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime())
                }
            )
            print(f"ðŸ”„ ãƒªãƒã‚¹ãƒˆ: {text[:40]}")
        reposted_uris.add(uri)
        repost_count += 1
    except Exception as e:
        print(f"âš ï¸ ãƒªãƒã‚¹ãƒˆå¤±æ•— (URI: {uri}): {e}")
        error_count += 1

def auto_repost_timeline():
    """ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æŠ•ç¨¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¯¾è±¡ã‚’ãƒªãƒã‚¹ãƒˆï¼ˆãƒªãƒ—é™¤å¤–ï¼‰"""
    global skip_count
    print("ðŸ“¡ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å·¡å›žä¸­...")
    try:
        feed_res = client.app.bsky.feed.get_timeline(params={"limit": 50})
        feed_items = feed_res.feed
        for item in feed_items:
            post = item.post
            text = post.record.text.lower()
            uri = post.uri
            cid = post.cid
            author_did = post.author.did

            # è‡ªå·±æŠ•ç¨¿ã€ãƒªãƒ—ã€ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—
            if author_did == self_did:
                print(f"â© è‡ªå·±æŠ•ç¨¿ã‚¹ã‚­ãƒƒãƒ—: {text[:40]}")
                skip_count += 1
                continue
            if hasattr(post.record, 'reply') and post.record.reply:
                print(f"â© ãƒªãƒ—ã‚¹ã‚­ãƒƒãƒ—: {text[:40]}")
                skip_count += 1
                continue
            if f"@{HANDLE.lower()}" in text:
                print(f"â© ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒƒãƒ—: {text[:40]}")
                skip_count += 1
                continue

            # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰/ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒžãƒƒãƒã§ãƒªãƒã‚¹ãƒˆ
            if any(tag.lower() in text for tag in TARGET_HASHTAGS) or any(kw.lower() in text for kw in TARGET_KEYWORDS):
                # å¼•ç”¨ãƒªãƒã‚¹ãƒˆï¼ˆ50%ã®ç¢ºçŽ‡ï¼‰
                is_quote = random.random() < 0.5
                repost_if_needed(uri, cid, text, post, is_quote=is_quote)
    except Exception as e:
        print(f"âŒ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: {e}")
        error_count += 1

def start():
    """ãƒªãƒã‚¹ãƒˆBotãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    global repost_count, skip_count, error_count
    print(f"ðŸš€ ã‚Šã½ã‚Šã‚“Bot èµ·å‹•ã—ã¾ã—ãŸ: @{HANDLE}")
    auto_repost_timeline()
    print(f"âœ… å®Ÿè¡Œå®Œäº†: ãƒªãƒã‚¹ãƒˆ {repost_count}ä»¶, ã‚¹ã‚­ãƒƒãƒ— {skip_count}ä»¶, ã‚¨ãƒ©ãƒ¼ {error_count}ä»¶")

if __name__ == "__main__":
    start()