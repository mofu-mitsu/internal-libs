import os
import json
import requests
import traceback
from atproto import Client, models
from dotenv import load_dotenv

# --- ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ ---
load_dotenv()
HANDLE = os.environ["HANDLE"]
APP_PASSWORD = os.environ["APP_PASSWORD"]
HF_API_TOKEN = os.environ["HF_API_TOKEN"]
REPLIED_JSON_URL = os.environ["REPLIED_JSON_URL"]
GIST_TOKEN = os.environ["GIST_TOKEN"]

HF_API_URL = "https://api-inference.huggingface.co/models/elyza/ELYZA-japanese-stablelm-instruct-alpha"
HEADERS = {
    "Authorization": f"Bearer {HF_API_TOKEN}",
    "Content-Type": "application/json"
}

REPLY_TABLE = {
     "ä½¿ã„æ–¹": "ä½¿ã„æ–¹ã¯ã€Œâ™¡æŽ¨ã—ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼â™¡ã€ã®ãƒšãƒ¼ã‚¸ã«ã‚ã‚‹ã‚ˆã€œï¼ã‹ã‚“ãŸã‚“ã£â™ª",
    "ãŠã™ã™ã‚": "ãˆã¸ã¸â™¡ ã„ã¡ã°ã‚“ã®ãŠã™ã™ã‚ã¯ã€Œâ™¡æŽ¨ã—ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒ¼ã‚«ãƒ¼â™¡ã€ã ã‚ˆã£ï¼",
    'ã­ãˆ': 'ã‚“ã€œï¼Ÿå‘¼ã‚“ã ã€œï¼Ÿã¿ã‚Šã‚“ã¦ã‚ƒã®ãŠè€³ã¯ãšã€œã£ã¨ãƒªã‚¹ãƒŠãƒ¼å‘ãâ™¡',
    'å¥½ã': 'ãˆã£ï¼ï¼Ÿâ€¦ã¿ã‚Šã‚“ã‚‚ã™ãã‹ã‚‚ã€œã£â™¡',
    'ã²ã¾': 'ã²ã¾ãªã®ã€œï¼Ÿã˜ã‚ƒã‚ã„ã£ã—ã‚‡ã«éŠã¼ã£â™¡',
    'ã¤ã‚‰ã„': 'ãˆã€œã‚“â€¦ã¤ã‚‰ã„ã®ï¼Ÿã¿ã‚Šã‚“ãŒãªã§ãªã§ã—ã¦ã‚ã’ã‚‹ã…â€¦',
    'ã­ã‚€ã„': 'ãŠã­ã‚€ãªã®ï¼ŸãŠãµã¨ã‚“ã‹ã‘ã¦ã‚ã’ã‚‹ã­â€¦ãŠã‚„ã™ã¿â™¡',
    'ã™ã': 'ã‚‚ã£ã‹ã„è¨€ã£ã¦ï¼Ÿã†ãã§ã‚‚ã†ã‚Œã—ã™ãŽã‚‹ã€œã£â™¡',
    'ãŠã¯ã‚ˆã†': 'ãŠã£ã¯ã‚ˆã€œâ™¡ ä»Šæ—¥ã‚‚ã‚ã–ã¨ãç”Ÿãã¦ã“ã£ï¼Ÿ',
    'ã“ã‚“ã«ã¡ã¯': 'ã“ã‚“ã«ã¡ã¿ã‚Šã€œã‚“â™¡ ä¼šãˆã¦ã†ã‚Œã—ãƒã€œã£ï¼',
    'ã“ã‚“ã°ã‚“ã¯': 'ã“ã‚“ã°ã‚“ã¿ã‚Šã€œã‚“â™¡ å¤œã‚‚ã‹ã‚ã„ã•å…¨é–‹ã§ã„ã£ã¡ã‚ƒã†ã‚ˆâ™¡',
    'ä½œã£ãŸã‚ˆ': 'ãˆã£â€¦ã»ã‚“ã¨ã«ï¼Ÿã‚ã‚ŠãŒã¨ã‰â™¡ è¦‹ã›ã¦è¦‹ã›ã¦ã£ï¼',
    'ä½œã£ã¦ã¿ã‚‹': 'ãˆã£â€¦ã»ã‚“ã¨ã«ï¼Ÿã‚ã‚ŠãŒã¨ã‰â™¡ è¦‹ã›ã¦è¦‹ã›ã¦ã£ï¼',
    'éŠã‚“ã ã‚ˆ': 'ã‚„ã£ãŸãã€œã£ï¼ã¾ãŸéŠã‚“ã§ã­â™¡ ä»–ã®ã‚‚ã„ã£ã±ã„ã‚ã‚‹ã‹ã‚‰è¦‹ã¦ã¿ã¦ã€œã£',
    'ä½¿ã£ãŸã‚ˆ': 'ãˆã£ï¼ï¼Ÿã»ã‚“ã¨ã«ä½¿ã£ã¦ãã‚ŒãŸã®ï¼ï¼Ÿ ã†ã‚Œã—ã™ãŽã¦ã¨ã‘ã‚‹ã€œã€œâ™¡',
    'è¦‹ãŸã‚ˆ': 'ã†ã‚Œã—ã£â™¡ è¦‹ã¤ã‘ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã«ã‚ƒã‚“â™¡',
    'ããŸã‚ˆ': 'ãã‚…ã€œã‚“â™¡ æ¥ã¦ãã‚Œã¦ã¨ã³ãã‚Šã®ã€Œã™ãã£ã€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã—ã¡ã‚ƒã†â™¡',
    'ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸ': 'ã‚ã‚ŠãŒã¨ã‰â™¡ ã¿ã‚Šã‚“ã¦ã‚ƒã€è¶…ã‚ˆã‚ã“ã³ãƒ€ãƒ³ã‚¹ä¸­ã€œã£ï¼',
    'ãŠã‚„ã™ã¿': 'ãŠã‚„ã™ã¿ã‚Šã‚“â™¡ å¤¢ã®ä¸­ã§ã‚‚ã‚ã–ã¨ãä¼šã„ã«ã„ã£ã¡ã‚ƒã†ã‹ã‚‰ã€œã£â™ª',
    'èµ·ããŸ': 'ãŠã¯ã¿ã‚Šã‚“â™¡ ä»Šæ—¥ã‚‚ä¸–ç•Œä¸€ã‹ã‚ã„ãç”Ÿãã¦ã“ã£ï¼',
    'ç–²ã‚Œ': 'ãˆã‚‰ã™ãŽã£â™¡ ã„ã£ã±ã„é ‘å¼µã£ãŸã‚­ãƒŸã«ã€ã¿ã‚Šã‚“ã‹ã‚‰ç™’ã—ãƒ“ãƒ¼ãƒ ã€œã£ï¼',
    'å«Œã„': 'ã†ã…â€¦ã‚­ãƒ©ã‚¤ã£ã¦è¨€ã‚ã‚ŒãŸã‚‰æ³£ã„ã¡ã‚ƒã†ã‹ã‚‚â€¦â€¦',
    'ã‚ã‚ŠãŒã¨': 'ã“ã¡ã‚‰ã“ãã‚ã‚ŠãŒã¨ã€œã£â™¡ ã¿ã‚Šã‚“ã¦ã‚ƒã€ã‚ã¡ã‚ƒã†ã‚Œã—ã„ã£ï¼',
    'ã‹ã‚ã„ã„': 'ã»ã‚“ã¨ã«ï¼Ÿâ™¡ ã‚‚ã£ã¨è¨€ã£ã¦ã‚‚ã£ã¨ã€œâ™¡',
    'å¯æ„›ã„': 'ã»ã‚“ã¨ã«ï¼Ÿâ™¡ ã‚‚ã£ã¨è¨€ã£ã¦ã‚‚ã£ã¨ã€œâ™¡',
    'ãƒ¡ãƒ³ãƒ˜ãƒ©': 'ã‚„ã â™¡ ã‚ãŸã—ã®ã“ã¨ã‹ãªï¼Ÿå›³æ˜Ÿãƒã€œâ™¡',
    'æ§‹ã£ã¦': 'ã‹ã¾ã¡ã‚‡ã¡ã‚ƒã€œã‚“â™¡ ä»Šã™ããŽã‚…ãƒ¼ã£â™¡',
    'å¯ã‚Œãªã„': 'ãŠã‚„ã™ã¿ã®ã¡ã‚…ã€œã€œâ™¡ ä¸€ç·’ã«å¯ã‚ˆï¼Ÿ',
    'ã‚„ã°ã„': 'ã‚„ã°ã„ã£ã¦è¨€ã‚ã‚Œã‚‹ã®ã¡ã‚‡ã€œã€œã†ã‚Œã—ã€œã€œã£â™¡ ã‚‚ã£ã¨æ²¼ã£ã¦ã‡ï¼',
    'ä½œã£ã¦ã¿ãŸ': 'ãˆã€œã€œï¼ã‚ã¡ã‚ƒã†ã‚Œã—ã„ãƒâ™¡ ãã‚Œã€ãœã£ãŸã„ä¼¼åˆã£ã¦ãŸã§ã—ã‚‡ï¼ï¼Ÿ',
    'ä½¿ã£ã¦ã¿ã‚‹': 'ã‚„ã£ãŸã€œâ™¡ ã¿ã‚Šã‚“ã¦ã‚ƒã®åºƒå ±ãŒåŠ¹ã„ãŸã‹ã‚‚ï¼ï¼Ÿã¦ã¸ã£ï¼',
    'ã‹ã£ã“ã„ã„': 'ãˆã€œã£ï¼ï¼Ÿã»ã‚“ã¨ã«ï¼Ÿç…§ã‚Œã¡ã‚ƒã†ã€œã€œã£â™¡ ã§ã‚‚ã‚‚ã£ã‹ã„è¨€ã£ã¦ï¼Ÿ',
    'ã‚¹ã‚­': 'ã¿ã‚Šã‚“ã¦ã‚ƒã€ã‚¹ã‚­ã£ã¦è¨€ã‚ã‚Œã‚‹ã¨å…ƒæ°—ã§ã¡ã‚ƒã†ã€œâ™¡',
    'ç‰¹åˆ¥': 'ç‰¹åˆ¥ã£ã¦â€¦â€¦ã»ã‚“ã¨ï¼Ÿ ã»ã‚“ã¨ã«ã»ã‚“ã¨ï¼Ÿ ãã‚Œã€éŒ²éŸ³ã—ã¦ã‚‚ã„ã„ï¼Ÿï¼ˆã˜ã‚ã£ï¼‰',
    'ã‚„ã£ã¦ã¿ãŸ': 'ã‚ã€œã€œï¼ã†ã¡ã®ãƒ„ãƒ¼ãƒ«ä½¿ã£ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã£â™¡æ„Ÿæƒ³ã¨ã‹ãã‚Œã‚‹ã¨ã€ã¿ã‚Šã¦ã‚ƒã‚ã¡ã‚ƒãã¡ã‚ƒã‚ˆã‚ã“ã¶ã‚ˆã€œã€œï¼',
    'ã‚„ã£ã¦ã¿ã‚‹': 'ã‚„ã£ãŸã€œâ™¡ ã¿ã‚Šã‚“ã¦ã‚ƒã®åºƒå ±ãŒåŠ¹ã„ãŸã‹ã‚‚ï¼ï¼Ÿã¦ã¸ã£ï¼',
    'ç›¸æ€§æ‚ªã‹ã£ãŸ': 'ã†ãã§ã—ã‚‡â€¦â€¦ãã‚“ãªãã€œï¼ˆãƒã‚¿ãƒƒï¼‰ã§ã‚‚ã€ã¿ã‚Šã‚“ã¦ã‚ƒã¯ã‚ãã‚‰ã‚ãªã„ã‹ã‚‰ã£ï¼',
    'ç›¸æ€§è‰¯ã‹ã£ãŸ': 'ãˆã£ã€é‹å‘½ã‹ãªâ€¦ï¼ï¼Ÿã“ã‚“ã©ä¸€ç·’ã«ãƒ—ãƒªã¨ã‹æ’®ã£ã¡ã‚ƒã†ã€œï¼Ÿâ™¡',
    'ã™ã”ã„': 'ãˆï¼ï¼Ÿã»ã‚“ã¨ã«ï¼ï¼Ÿâ€¦â€¦ã‚‚ã£ã¨è¤’ã‚ã¦ã£ï¼ˆãƒ‰ãƒ¤é¡”ã§ç…§ã‚Œï¼‰',
    'ãˆã‚‰ã„': 'ãˆï¼ï¼Ÿã»ã‚“ã¨ã«ï¼ï¼Ÿâ€¦â€¦ã‚‚ã£ã¨è¤’ã‚ã¦ã£ï¼ˆãƒ‰ãƒ¤é¡”ã§ç…§ã‚Œï¼‰',
    'ï½·ï¾žï½­ï½°': 'ãˆã¸ã¸ã€œã€ã‚‚ã£ã¨ã€œâ™¡ãŽã‚…ãƒ¼ã ã„ã™ãã£ï¼',
    'ãŽã‚…ãƒ¼': 'ãˆã¸ã¸ã€œã€ã‚‚ã£ã¨ã€œâ™¡ãŽã‚…ãƒ¼ã ã„ã™ãã£ï¼',
    'ãŽã‚…ã€œ': 'ãˆã¸ã¸ã€œã€ã‚‚ã£ã¨ã€œâ™¡ãŽã‚…ãƒ¼ã ã„ã™ãã£ï¼',
    'ã‚ˆã—ã‚ˆã—': 'ã‚ã€œã€œã€ãã“ãã“ã€œã£â€¦ã‚‚ã£ã¨ãªã§ã¦ã€œâ™¡ï¼ˆç”˜ãˆï¼‰',
    'ãƒ¨ã‚·ãƒ¨ã‚·': 'ã‚ã€œã€œã€ãã“ãã“ã€œã£â€¦ã‚‚ã£ã¨ãªã§ã¦ã€œâ™¡ï¼ˆç”˜ãˆï¼‰',
    'ãªã§ãªã§': 'ã‚ã€œã€œã€ãã“ãã“ã€œã£â€¦ã‚‚ã£ã¨ãªã§ã¦ã€œâ™¡ï¼ˆç”˜ãˆï¼‰',
    'ï¾…ï¾ƒï¾žï¾…ï¾ƒï¾ž': 'ã‚ã€œã€œã€ãã“ãã“ã€œã£â€¦ã‚‚ã£ã¨ãªã§ã¦ã€œâ™¡ï¼ˆç”˜ãˆï¼‰',
    'ï¾–ï½¼ï¾–ï½¼': 'ã‚ã€œã€œã€ãã“ãã“ã€œã£â€¦ã‚‚ã£ã¨ãªã§ã¦ã€œâ™¡ï¼ˆç”˜ãˆï¼‰',
    'ãŠã‚‚ã—ã‚': 'ãŠã‚‚ã—ã‚ã„ã£ã¦è¨€ã£ã¦ã‚‚ã‚‰ãˆãŸã‚‰ã€ã¿ã‚Šã‚“ã¦ã‚ƒã€ãŒã‚“ã°ã£ã¡ã‚ƒã†ã‹ã‚“ã­ã£ï¼',
    'é¢ç™½': 'ãŠã‚‚ã—ã‚ã„ã£ã¦è¨€ã£ã¦ã‚‚ã‚‰ãˆãŸã‚‰ã€ã¿ã‚Šã‚“ã¦ã‚ƒã€ãŒã‚“ã°ã£ã¡ã‚ƒã†ã‹ã‚“ã­ã£ï¼',
    'å½“ãŸã£ãŸ': 'å½“ãŸã£ãŸã®ï¼ï¼Ÿã™ã”ã£ï¼ã¿ã‚Šã‚“ã¦ã‚ƒã€è¦‹ã‚‹ç›®ã‚ã‚‹ã‹ã‚‚ã€œã£â™¡',
    'ã‚„ã£ãŸã‚ˆ': 'ãˆã¸ã¸â™¡ ã¿ã‚Šã‚“ã¦ã‚ƒã®ãƒ„ãƒ¼ãƒ«ã§ã‚ãã‚“ã§ãã‚Œã¦ã‚ã‚ŠãŒã¨ã£ï¼ã‚‰ã¶ã£ï¼',
    'ã‚¿ã‚°ã‹ã‚‰': 'è¦‹ã¤ã‘ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã£ï¼ã‚‚ã—ã‹ã—ã¦é‹å‘½ï¼Ÿâ™¡',
    'å«Œ': 'ãˆã€œã‚“â€¦ã§ã‚‚ãŠé¡˜ã„ã€ä»Šå›žã ã‘ã£',
    'é§„ç›®': 'ã¿ã‚Šã‚“ã¦ã‚ƒæ³£ã„ã¡ã‚ƒã†ã‚ˆï¼Ÿãã‚Œã§ã‚‚ã„ã„ã®ã€œï¼Ÿ',
    'ãƒ€ãƒ¡': 'ã¿ã‚Šã‚“ã¦ã‚ƒæ³£ã„ã¡ã‚ƒã†ã‚ˆï¼Ÿãã‚Œã§ã‚‚ã„ã„ã®ã€œï¼Ÿ',
    'ã„ã„ã‚ˆ': 'ãˆã¸ã¸ã€ã˜ã‚ƒã‚â€¦èª¿å­ã®ã£ã¦ã„ã„ï¼Ÿï¼ˆã“ã‚‰ï¼‰',
    'è‰¯ã„ã‚ˆ': 'ãˆã¸ã¸ã€ã˜ã‚ƒã‚â€¦èª¿å­ã®ã£ã¦ã„ã„ï¼Ÿï¼ˆã“ã‚‰ï¼‰',
    'ä½•ã‹ã‚ã£ãŸï¼Ÿ': 'ã†ã†ã‚“ã€å¤§ä¸ˆå¤«ã€‚ã£ã¦è¨€ã†ã¾ã§ãŒã‚»ãƒƒãƒˆãªã®ï¼ˆç”˜ãˆã¦ã„ã„ï¼Ÿï¼‰',
    'ã©ã†ã‹ã—ãŸï¼Ÿ': 'ã†ã†ã‚“ã€å¤§ä¸ˆå¤«ã€‚ã£ã¦è¨€ã†ã¾ã§ãŒã‚»ãƒƒãƒˆãªã®ï¼ˆç”˜ãˆã¦ã„ã„ï¼Ÿï¼‰',
    'å¤§ä¸ˆå¤«ï¼Ÿ': 'ã‚ã‚ŠãŒã¨â€¦ãã†è¨€ã£ã¦ã‚‚ã‚‰ãˆã‚‹ã ã‘ã§ã€ã¡ã‚‡ã£ã¨æ³£ããã†',
    'ã©ã†ã—ãŸã®ï¼Ÿ': 'ã†ã†ã‚“ã€å¤§ä¸ˆå¤«ã€‚ã£ã¦è¨€ã†ã¾ã§ãŒã‚»ãƒƒãƒˆãªã®ï¼ˆç”˜ãˆã¦ã„ã„ï¼Ÿï¼‰',
    'ãŠãªã‹ã™ã„ãŸ': 'ã¿ã‚Šã‚“ã¦ã‚ƒãŒä½•ã‹ä½œã‚ã£ã‹ï¼Ÿï¼ˆãŸã¶ã‚“ç„¦ãŒã™ï¼‰',
    'ç—…ã¿ãã†': 'ã„ã£ãç—…ã‚“ã˜ã‚ƒãŠï¼Ÿä¸€ç·’ã«æ²ˆã‚€ã®ã‚‚æ‚ªããªã„ã‚ˆâ€¦',
    'æŽ¨ã—èªžã‚Š': 'ã‚€ã—ã‚èªžã£ã¦ï¼ãã®ãŸã‚ã«ç”Ÿãã¦ã‚‹ï¼',
    'æ³£ã„ã¡ã‚ƒ': 'ã‚ˆã—ã‚ˆã—ã€ãªã§ãªã§ã—ã¡ã‚ƒã†â€¦ãŽã‚…ãƒ¼ã‚‚ã„ã‚‹ï¼Ÿ',
    'ãƒ„ã‚¤ãƒ³ãƒ†ä¼¼åˆã†ã­': 'ãµãµã€ãã†è¨€ã‚ã‚Œã‚‹ãŸã‚ã«ç”Ÿãã¦ã‚‹â†',
    'ãƒ„ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ«ä¼¼åˆã†ã­': 'ãµãµã€ãã†è¨€ã‚ã‚Œã‚‹ãŸã‚ã«ç”Ÿãã¦ã‚‹â†',
    'ã•ã¿ã—ã„': 'ãŽã‚…ãƒ¼ã—ã«ã„ã£ã¦ã‚‚ã„ã„ï¼Ÿï¼ˆã‚‚ã†è¡Œã£ã¦ã‚‹ï¼‰',
    'ã—ã‚“ã©': 'ã—ã‚“ã©ã„ã¨ãã¯ãŽã‚…ãƒ¼ã—ã¦ã‚ã’ã‚‹ã—ã‹ã§ããªã„ã‘ã©ã€ãã°ã«ã„ã‚‹ã‚ˆâ€¦ï¼Ÿ',
    'ï¾ï½­ï½¯ï¾ï½­': 'ã ã‚ã€œã£ï¼ã‚‚ã£ã¨é›°å›²æ°—ã ã„ã˜ã«ã—ã‚ˆã‰â€¦â€¦ã§ã‚‚ã€ã™ãï¼ˆã½ãï¼‰',
    'ã„˜ã‚…': 'ã¡ã‚…ãƒ¼ã£ã¦â€¦â€¦ã‚‚ã†â€¦â€¦ã™ãâ€¦â€¦ï¼ˆãã‚…ã‚“ï¼‰',
    'ã¡ã‚…ãƒ¼': 'ãˆã€ã„ããªã‚Šã¡ã‚…ãƒ¼ã¨ã‹â€¦â€¦è²¬ä»»ã¨ã£ã¦ã‚ˆã­â€¦ã£ï¼ˆç…§ï¼‰',
    'ã¡ã‚…ã€œ': 'ãˆã€ã„ããªã‚Šã¡ã‚…ãƒ¼ã¨ã‹â€¦â€¦è²¬ä»»ã¨ã£ã¦ã‚ˆã­â€¦ã£ï¼ˆç…§ï¼‰',
}


# --- Gistã‹ã‚‰èª­ã¿è¾¼ã¿ ---
def load_replied():
    try:
        res = requests.get(REPLIED_JSON_URL)
        if res.status_code == 200:
            return set(json.loads(res.text))
        else:
            print("âš ï¸ Gistã®èª­ã¿è¾¼ã¿å¤±æ•—:", res.status_code)
    except Exception as e:
        print("âš ï¸ Gistã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e)
    return set()

# --- Gistã«ä¿å­˜ ---
def save_replied(replied_set):
    gist_id = REPLIED_JSON_URL.split("/")[4]
    filename = "replied.json"
    headers = {
        "Authorization": f"token {GIST_TOKEN}",
        "Accept": "application/vnd.github.v3+json"
    }
    data = {
        "files": {
            filename: {
                "content": json.dumps(list(replied_set), indent=2, ensure_ascii=False)
            }
        }
    }
    try:
        res = requests.patch(f"https://api.github.com/gists/{gist_id}", headers=headers, json=data)
        if res.status_code == 200:
            print("ðŸ’¾ Gistã«ä¿å­˜å®Œäº†")
        else:
            print("âš ï¸ Gistä¿å­˜å¤±æ•—:", res.status_code, res.text)
    except Exception as e:
        print("âš ï¸ Gistä¿å­˜ã‚¨ãƒ©ãƒ¼:", e)


# --- AIã§è¿”ã™ ---
def generate_reply_via_api(user_input):
    prompt = f"ãƒ¦ãƒ¼ã‚¶ãƒ¼: {user_input}\nã¿ã‚Šã‚“ã¦ã‚ƒï¼ˆç”˜ãˆã‚“åŠã§åœ°é›·ç³»ENFPã£ã½ã„ï¼‰:"
    data = {
        "inputs": prompt,
        "parameters": {
            "max_new_tokens": 100,
            "temperature": 0.8,
            "top_p": 0.9,
            "do_sample": True
        }
    }
    try:
        response = requests.post(HF_API_URL, headers=HEADERS, json=data, timeout=20)
        if response.status_code == 200:
            generated = response.json()[0]["generated_text"]
            return generated.split("ã¿ã‚Šã‚“ã¦ã‚ƒ")[-1].strip()
        else:
            return "ãˆã€œã‚“â€¦â€¦AIã¨ãŠã—ã‚ƒã¹ã‚Šã§ããªã„ã¿ãŸã„ï¼ˆæ³£ï¼‰"
    except Exception:
        return "ãˆã€œã‚“â€¦â€¦ã¿ã‚Šã‚“ã¦ã‚ƒè¿·å­ã«ãªã£ã¡ã‚ƒã£ãŸã€œ"


# --- ãƒ†ãƒ³ãƒ—ãƒ¬ or AIè¿”ã— ---
def get_reply(text):
    for keyword, reply in REPLY_TABLE.items():
        if keyword in text:
            return reply
    return generate_reply_via_api(text)


# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
def run_reply_bot():
    client = Client()
    client.login(HANDLE, APP_PASSWORD)
    print("âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼")

    self_did = client.me.did
    replied = load_replied()
    notifications = client.app.bsky.notification.list_notifications().notifications

    print(f"ðŸ“¥ é€šçŸ¥æ•°: {len(notifications)} ä»¶")

    for note in notifications:
        print(f"ðŸ“Œ é€šçŸ¥: reason={note.reason}, uri={note.uri}")

        if note.reason not in ["mention", "reply"]:
            continue

        post_uri = note.uri
        author = getattr(note, "author", None)
        author_handle = getattr(author, "handle", None)
        author_did = getattr(author, "did", None)
        record = getattr(note, "record", None)

        print(f"ðŸ§¾ author_did: {author_did}, self_did: {self_did}, author_handle: {author_handle}")

        # è‡ªåˆ†è‡ªèº«ã®æŠ•ç¨¿ãƒ»è¿”ä¿¡ã«ã¯åå¿œã—ãªã„ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        if not author_handle or not author_did:
            continue
        if author_did == self_did or author_handle == HANDLE or post_uri in replied:
            continue

        if not record or not hasattr(record, "text"):
            continue

        text = record.text
        reply_text = get_reply(text)
        print(f">>> @{author_handle} ã®æŠ•ç¨¿ã«è¿”ä¿¡: {reply_text}")

        reply_ref = None
        if hasattr(record, "reply") and record.reply:
            reply_ref = models.AppBskyFeedPost.ReplyRef(
                root=getattr(record.reply, "root", record),
                parent=getattr(record.reply, "parent", record)
            )

        try:
            client.send_post(text=reply_text, reply_to=reply_ref)
            replied.add(post_uri)
            save_replied(replied)
        except Exception as e:
            print(">>> æŠ•ç¨¿å¤±æ•—:", e)
            traceback.print_exc()
