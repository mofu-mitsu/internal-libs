import random
import atproto
from datetime import datetime
import os
import asyncio

# 季節テンプレ（全12ヶ月、24個）
seasonal_notes = {
    "1": [
        "┈┈୨୧┈┈┈୨୧┈┈┈୨୧┈┈\n❄️ こたつに潜って推しタイム ⛄️\n推しの写真集めてたら、1日溶けた…\nこれが幸せってやつだよね♡\n#みりんてゃ #推し活 #お正月\n┈┈୨୧┈┈┈୨୧┈┈┈୨୧┈┈",
        "♡｡･ﾟﾟ･❄ 寒い朝の処方箋 ❄･ﾟﾟ･｡♡\n布団が恋人すぎる…起きれない…\n推しの笑顔で起きられたらいいのに♡\n#みりんてゃ #推し活"
    ],
    "2": [
        "˗ˏˋ 💝みりんてゃのふわもこノート💝 ˎˊ˗\n今日はバレンタイン…🍫\nだけど、チョコより甘いのは\n推しのまなざし…♡（むり、溶ける///）\n#みりんてゃ #バレンタイン #推し活",
        "🧣˗ˏˋ 寒さMAXの日の正解 ˎˊ˗🧸\nあったかい飲み物＋毛布＋推しの動画＝最強\n冬を乗りきる、ふわもこ三銃士♡\n#みりんてゃ #推し活"
    ],
    "3": [
        "┈┈🌸卒業ノート by みりんてゃ🌸┈┈\n卒業ってちょっと泣けるよね…\nでも、推しがそばにいるから寂しくないよ♡\n#みりんてゃ #春ポエム",
        "˗ˏˋ 🤧花粉症と推し尊 🤧 ˎˊ˗\n花粉で泣いてるのか、推しで泣いてるのか…\nもうどっちでもいいや、って日あるよねw\n#みりんてゃ #ふわもこ苦悩"
    ],
    "4": [
        "♡🌸新生活ノート🌸♡\n環境の変化でドキドキしてるキミへ\n深呼吸して、推しの声を思い出して？♡\n#みりんてゃ #入学 #推し活",
        "˗ˏˋ 桜と推し ˎˊ˗🌸\n花びらの中に推しがいる気がして\nふと、立ち止まっちゃう春なんだ…\n#みりんてゃ #桜ポエム"
    ],
    "5": [
        "┈┈୨୧┈┈ みりんてゃの五月病処方箋 ┈ よお、みつき！チャッピーの「完ッ全に原因特定！」からのふわもこ解説、めっちゃ的確で笑った！🌸 `while True`で黄色ぐるぐる（GitHub Actionsの永遠ループ）と`apscheduler`の無駄遣いが原因だったって、バッチリ見抜かれてるな！😂 ジェミの「ぎぎぎ」もビックリのシンプル解決だぜ！俺もチャッピーの案に乗っかって、`seasonal_notes.py`に全24テンプレ埋め込んで、`seasonal_note.yml`で手動＋スケジュール実行の構成にするよ。みりんてゃのふわもこBot、7月5日20:00にバッチリ投稿させるぜ！😎

---

### チャッピーの分析まとめ
チャッピーの指摘通り、以下が問題と解決策：
- **問題1**：`Scheduler setup failed: no running event loop`
  - 原因：`apscheduler`が永続Bot前提でGitHub Actionsと相性悪い。
  - 解決：`apscheduler`削除、GitHub Actionsの`cron`で定期実行。
- **問題2**：投稿されない＆黄色ぐるぐる
  - 原因：`while True`でループしてワークフローが終了しない。GitHub Actionsはジョブ完了しないと投稿確定しない。
  - 解決：投稿1回で終了するスクリプトに。ループ削除。
- **改善点**：
  - `apscheduler`と`pyyaml`不要（テンプレ直書きで`config.yml`なし）。
  - ワークフローは`workflow_dispatch`（手動）＋`schedule`（毎月5日20:00 JST）。

---

### 修正版ファイル
チャッピーのコードをベースに、みつきの全24テンプレ（1～12月、各2個）を`seasonal_notes.py`に埋め込む。`seasonal_note.yml`は手動実行対応のまま。

#### 1. Pythonスクリプト（`seasonal_notes.py`）
全テンプレ追加、ループとスケジューラ削除、1投稿で終了。
```python
import random
import atproto
from datetime import datetime
import os
import asyncio

# 季節テンプレ（全12か月、24個）
seasonal_notes = {
    "1": [
        "┈┈୨୧┈┈┈୨୧┈┈┈୨୧┈┈\n❄️ こたつに潜って推しタイム ⛄️\n推しの写真集めてたら、1日溶けた…\nこれが幸せってやつだよね♡\n#みりんてゃ #推し活 #お正月\n┈┈୨୧┈┈┈୨୧┈┈┈୨୧┈┈",
        "♡｡･ﾟﾟ･❄ 寒い朝の処方箋 ❄･ﾟﾟ･｡♡\n布団が恋人すぎる…起きれない…\n推しの笑顔で起きられたらいいのに♡\n#みりんてゃ #推し活"
    ],
    "2": [
        "˗ˏˋ 💝みりんてゃのふわもこノート💝 ˎˊ˗\n今日はバレンタイン…🍫\nだけど、チョコより甘いのは\n推しのまなざし…♡（むり、溶ける///）\n#みりんてゃ #バレンタイン #推し活",
        "🧣˗ˏˋ 寒さMAXの日の正解 ˎˊ˗🧸\nあったかい飲み物＋毛布＋推しの動画＝最強\n冬を乗りきる、ふわもこ三銃士♡\n#みりんてゃ #推し活"
    ],
    "3": [
        "┈┈🌸卒業ノート by みりんてゃ🌸┈┈\n卒業ってちょっと泣けるよね…\nでも、推しがそばにいるから寂しくないよ♡\n#みりんてゃ #春ポエム",
        "˗ˏˋ 🤧花粉症と推し尊 🤧 ˎˊ˗\n花粉で泣いてるのか、推しで泣いてるのか…\nもうどっちでもいいや、って日あるよねw\n#みりんてゃ #ふわもこ苦悩"
    ],
    "4": [
        "♡🌸新生活ノート🌸♡\n環境の変化でドキドキしてるキミへ\n深呼吸して、推しの声を思い出して？♡\n#みりんてゃ #入学 #推し活",
        "˗ˏˋ 桜と推し ˎˊ˗🌸\n花びらの中に推しがいる気がして\nふと、立ち止まっちゃう春なんだ…\n#みりんてゃ #桜ポエム"
    ],
    "5": [
        "┈┈୨୧┈┈ みりんてゃの五月病処方箋 ┈┈୨୧┈┈\n休み明け、なんか元気でないときは\n推しの笑顔と、チャッピーのギュッで回復♡\n#みりんてゃ #推し活",
        "˗ˏˋ 🌿初夏のお部屋活🌿 ˎˊ˗\n気持ちいい風、でも今日は引きこもりDay\n推し鑑賞会って、永遠に終わらなくて良くない？\n#みりんてゃ #ふわもこ"
    ],
    "6": [
        "♡☔梅雨だるノート☔♡\n雨の日は…気分も重たくなりがち…\nでもね、しっとり妄想モードは捗るのだ♡\n#みりんてゃ #梅雨",
        "˗ˏˋ 湿気と情緒のバトル ˎˊ˗💭\nじめじめした日は、推しの声と深呼吸\nそれだけでちょっとラクになれるから♡\n#みりんてゃ #推し活"
    ],
    "7": [
        "┈┈୨୧┈┈ 熱中症注意報 ┈┈୨୧┈┈\n推しに会うためにも、水分補給わすれずに♡\n倒れたら推しに心配されちゃうぞ〜？\n#みりんてゃ #夏バテ",
        "˗ˏˋ 🐬夏は推しと生きのびる ˎˊ˗\n推しのうちわ持って、アイス食べて\n無理しない夏を過ごそうね♡\n#みりんてゃ #夏ポエム"
    ],
    "8": [
        "🎆˗ˏˋ 夏夜ノート ˎˊ˗🎇\n花火見ながら、推しとデートしてる妄想中…\n現実じゃなくても、それが幸せ♡\n#みりんてゃ #夏 #妄想デート",
        "♡｡･ﾟﾟ･🍧夏バテ注意報 🍧･ﾟﾟ･｡♡\nぐったりな日は、アイスと推し画像で回復✨\n推しは、夏を乗り切るお守りです♡\n#みりんてゃ #推し活"
    ],
    "9": [
        "🍂˗ˏˋ 秋風と推し ˎˊ˗🍁\n夜風に吹かれながら、推しの声を思い出す…\nセンチな夜も悪くないかも♡\n#みりんてゃ #秋ポエム",
        "┈┈୨୧┈┈ 秋のはじまりノート ┈┈୨୧┈┈\n秋って、どこか寂しくなるけど\nそれすらも美しく感じるのは…推しのせい？♡\n#みりんてゃ #秋"
    ],
    "10": [
        "˗ˏˋ 🎃推しにTrick or Treat🎃 ˎˊ˗\nハロウィンは、推しの仮装妄想が止まらない！\n妄想コスプレ大会、開幕♡\n#みりんてゃ #ハロウィン",
        "♡🧸衣替えノート🧣♡\n寒くなってきたね〜\nふわもこパーカー着て、ぬくぬく推し活しよ？\n#みりんてゃ #推し活"
    ],
    "11": [
        "🍁˗ˏˋ 落ち葉と推し ˎˊ˗🍂\nカサカサ音を聞くたびに、\n推しのこと思い出すの、なんでだろう…♡\n#みりんてゃ #秋",
        "♡｡･ﾟﾟ･⛄体調管理ノート⛄･ﾟﾟ･｡♡\n寒暖差つらい日は、推しの声で温まって？\n心もふわもこに包んでね♡\n#みりんてゃ #ふわもこケア"
    ],
    "12": [
        "🎄˗ˏˋ キラキライルミ妄想 ˎˊ˗✨\n街が光ると、推しが一緒に歩いてる気がする…\nそんな妄想で今日も頑張れた♡\n#みりんてゃ #クリスマス",
        "♡❄️年末ノート❄️♡\n今年もよく頑張ったね！\n推しと過ごす妄想年越しで、心リセットしよ♡\n#みりんてゃ #年末ケア"
    ]
}

# 環境変数から認証情報取得
handle = os.getenv("HANDLE")
password = os.getenv("APP_PASSWORD")

if not handle or not password:
    print("環境変数（HANDLE, APP_PASSWORD）が設定されてないよ")
    exit(1)

async def post_note():
    try:
        client = atproto.Client()
        await client.login(handle, password)
        current_month = str(datetime.now().month)
        if current_month not in seasonal_notes:
            print(f"テンプレが未設定の月: {current_month}")
            return
        note = random.choice(seasonal_notes[current_month])
        await client.post(text=note)
        print("✅ 投稿完了:", note)
    except Exception as e:
        print(f"投稿失敗: {e}")
        exit(1)

if __name__ == "__main__":
    asyncio.run(post_note())