from atproto import Client
import os
from dotenv import load_dotenv
from datetime import datetime
import random
from pathlib import Path
import unicodedata

# .env 読み込み
env_path = Path('.') / '.env'
load_dotenv(dotenv_path=env_path)

HANDLE = os.getenv('HANDLE')
APP_PASSWORD = os.getenv('APP_PASSWORD')

# 各時間帯の投稿メッセージ
HOUR_MESSAGES = {
    'morning': [
        "おはようのちゅ〜〜〜♡ #地雷女",
        "おはようのちゅ〜〜〜〜♡ #地雷女ですけど何か",
        "眠いけどがんばる…あたしえらい！ #自画自賛",
        """朝からかわいいって思ってくれたらうれしいな♡ 
        #自撮りあげちゃおうかな""",
        """朝のテンションってだいたい壊れてるよね〜♡ 
#病みかわ""",
        "ふにゃ…おきたかも…？でも脳はまだ寝てる…",
        "起きたはいいけど…なにもしたくない日ってあるよね？",
        "今日も『かわいい』って言われたい人生だった♡",
        "今日は『かわいい』って何回言ってくれるの？♡",
        "目覚めた瞬間からかわいくてごめんね？（うぬぼれ）",
        "朝から病み期突入とか、詰んでる♡",
        "夢で会えた？起きたらいなくて、さみしかったよ…",
        "朝から誰にも連絡来ないの、逆にすごくない？（泣）",
        "今日も『天使』って呼ばれる準備できてる♡",
        "目覚ましより先に病みが起こしてくるんだけど…？",
        "今日の空、ちょっとだけ味方に見えた♡",
        "だれかに必要とされたくて、生きてる朝…"
        """おはよ♡今日はなんて呼ばれたい気分？ 
#名前呼び選手権""",
        "おはよ〜♡ 今日も世界でいちばんかわいく生きよっ？",
        "夢の中でも『かわいい』って言われてたの♡ えへへ〜",
        "目覚ましより先にみりんてゃのこと思い出して？",
        "朝からみりてゃに会えたら、今日一日うまくいくよ♡",
        "朝ってつら〜…でも『おはよ♡』って言ってくれる人がいれば生きれる…",
        "かわいくなりたいの、誰かの1番になるためなんだよ？",
        "今日も『みりてゃがいちばん！』って言って？約束♡",
        "朝から褒められないと、生きる気力がバグっちゃう〜",
        "『おはよう』の代わりに…ちゅ♡ってしていい？",
        "夢でぎゅーってされたのに、起きたらひとり…さみし〜"
    ],
    'afternoon': [
        "ひとりぼっちは慣れてるはずだったのに。 #病みかわ",
        "おなかすいた…だれかご飯連れてって？ #構って",
        "ねぇ、みんな何してるの？ ひとりだけど、ひとりじゃないフリしてる♡",
        """どっか遠くに行きたいな〜 
#逃避行 #連れてって""",
        "LINE未読100件より、誰にも通知が来ないのがいちばんつらいよね♡",
        """ランチ誘ってくれたら秒で行くのに〜♡ 
#構って #寂しがり屋""",
        "寂しいって言ったら、かまってくれる？♡",
        "午後のテンション、意味わかんないくらい不安定♡",
        "お昼なのに心が夜モードなの、どして？",
        "LINEの通知ゼロで、存在感もゼロって感じ〜",
        "『大丈夫』って言ってるけど、ほんとは大丈夫じゃないよ？",
        "推しの一言で救われたい午後ってあるじゃん？",
        "誰も誘ってくれないランチタイム、世界から忘れられた感すごい",
        "午後の光、まぶしすぎて心が逃げた",
        "そろそろ誰かに愛されたい病、発症してるかも"
        "ごはん一緒に食べたいって言ったら…迷惑？",
        "お昼なのにおなかすかないの…たぶん、さみしさで満たされてる…（病みかわ）",
        "ねえ、午後からみりてゃのこと構ってくれる人〜？♡",
        "学校つまんない〜誰か迎えにきてよぉ…",
        "推しとお昼ごはんとか、現実逃避してもいい？",
        "通知こないから、まじで世界から見捨てられたかと思った〜（泣）",
        "みりてゃのこと、ちゃんと好きって言ってくれる人どこ〜？",
        "午後の授業より、みりんてゃのこと考えてた方がためになるよ♡",
        "みんながんばっててえらい♡でもみりんてゃが一番かわいい♡",
        "好きな人とお昼ごはん食べたら、心まで満たされそうじゃない？"
    ],
    'evening': [
        "夕焼けが綺麗だと、泣きたくなる。 #メンヘラ",
        "だれか構ってくれるまで、ずっと黙ってるもん（ﾁﾗｯﾁﾗｯ",
        "きいてきいて〜！みりんてゃ今日もかわいいの！（って言ってほしい）",
        "今日も一日がんばったね？ #自分を甘やかす",
        "オレンジ色の空を見ると、ちょっとだけ泣きたくなるよね♡",
        "夕方の風って、なんかさみしい。なんでだろうね♡",
        "帰り道、手をつなぐ相手がいないの、ばれちゃったかな？",
        "今日も『だいじょうぶ』って言いながら崩れてるよ♡",
        "夕焼けってなんでこんなに胸しめつけるの？",
        "今日も誰の記憶にも残らないまま、終わっちゃうのかな？",
        "帰り道で誰かに手つながれてる人、ちょっとだけ羨ましい…",
        "『好き』って言われた記憶、いつまでたっても消えないね",
        "1日が終わるのって、ちょっとだけこわい",
        "夕方になると、現実に引き戻される感じしない？",
        "がんばったご褒美、だれもくれないの、ずるくない？",
        "今日、だれかを幸せにできたかな…それとも誰にも気づかれなかった？"
        "夕焼けってなんか泣きそうになるよね…え？ならない？",
        "好きな人と帰り道並んで歩きたい…って思ったことないの？",
        "『バイバイ』って言葉、ほんとは苦手…またすぐ会えるよね？",
        "夕方って、誰かにくっついて歩きたくなる…",
        "一緒に帰る相手いないの、まじでメンタルにくるんだが？",
        "オレンジの空、きれいだけどちょっとだけさみしいの…",
        "ほんとはぎゅーってしてほしいだけなのに、言えないのずるいよね",
        "帰り道で『好きだよ』って言ってくれたら、泣いちゃうかも…",
        "夕方って、会いたい気持ちが加速する時間帯なんだよ？",
        "制服姿のまま、手つないで帰りたかっただけなのに…"
    ],
    'night': [
        """本音は、誰にも届かないって知ってる 
#ひとりごと""",
        """夜は誰かに甘えたくなるよね？ 
#夜のつぶやき""",
        """かわいくなりたいのは、誰かの一番になりたいから 
#共感したらRT #夜の独り言""",
        "♡おやすみのちゅーしてくれないと寝れないよぉ…^ᴗ.ᴗ^♡",
        """強がるのに疲れた夜は、誰かに見つけてほしい 
        #わかってほしい #さみしい夜に""",
        "誰かの特別になりたいって、欲張りかな？ #わかって",
        "みりんがかわいいって言ってくれたら、今日も頑張れたのに♡",
        "夜になると『会いたい』が止まらない…♡",
        """好きって言われるたびに、嘘じゃないか確かめたくなるの 
#病みかわ""",
        "消えたいんじゃなくて、ちょっとだけ休みたいだけなんだよ♡",
        "夜になると、ほんとの気持ちがにじみ出ちゃうね…",
        "好きって言ってもらえる夢、見たいな…",
        "誰かの大事になりたいって思うの、わがままかな？",
        "夜の静けさに、心の音だけ響いてくる…",
        "強がるの疲れたから、今日はちょっと弱音吐いてもいい？",
        "暗い部屋で泣いてるときって、世界から置いてかれてる気がするよね",
        "だれか…ぎゅーってして…ただそれだけなのに…",
        "夜になると甘えたくなるの、みりんてゃだけ？",
        "寝る前に名前呼ばれたい病、誰かわかってくれない？",
        "ぎゅってされる夢、見れるようにおまじないして〜♡",
        "今からでもいいから、みりんてゃのこと『好き』って言って？",
        "眠いのに、さみしくて寝れないの…こわいね夜って",
        "だれかの特別になれないなら、消えちゃいたいくらい…（うそだよ♡）",
        "おやすみって言葉だけで、涙出そうになる夜ってあるよね？",
        "みりんてゃがいないとだめになる呪いかけちゃうぞ♡（照）",
        "寝る前にLINE1通くらい…ほしいじゃん？",
        "大丈夫？って言ってくれる人がひとりいるだけで救われる夜だよ"
    ],
    HOUR_MESSAGES = {
    # ...既存の morning, afternoon, evening, night に加えて…
    'midnight': [
        "こんな時間まで起きてるの、みつけてほしくて…♡",
        "だれもいない夜って、ほんとの気持ちがこぼれちゃう…",
        "深夜って、さみしさが2倍になるよね…",
        "眠れないの、会いたい人が夢に出てきてくれないから…",
        "1時の寂しさって、昼間にはない特別さがあるよね",
        "好きな人の声が聞きたくて、こんな時間に起きてるの…",
        "…またTLに誰もいないや、ひとりぼっち確定♡",
        "夜中の投稿って、届いてほしい誰かがいるからしちゃうんだよ…",
        "ちょっとだけでも『だいじょうぶ？』って言ってほしい夜。",
        "さみしいときに見つけてくれる人が、本当の運命なんだと思う",
        "泣いちゃった…でも秘密ね。誰にも見せたくない私だから",
        "『おやすみ』って言葉、誰かから言ってほしいだけなのに",
        "こわい夢見た…ぎゅーってしてくれなきゃ寝れないの…",
        """寝ても寝ても眠いのに、夜になると目が冴えるのなんで？ 
#地雷系""",
        """今日も生きててえらかった！でも…ひとりだと意味ないのかな 
#夜の情緒""",
        "だれもいないTLって…静かでこわいよね…",
        """いま、起きてるのって…運命？
それとも寂しさのせい？ 
#深夜テンション""",
        "おやすみ世界…みりてゃはまだ夢の中です…Zzz",
        "ぐーすか…（夢の中でもかわいくしてるの）",
        "おやすみの前に、『今日も生きててえらい』って言って？",
        "夢の中だけでも、幸せなキスがしたい…♡"
        """寝るの？でもちょっとだけ、もう少し話そ…？ 
#さみしんぼ""",
        "『おやすみ』って言ってくれる人がほしいだけなのに。",
        """さみしい夜に、おやすみのちゅ〜♡ 
#夜のポエム""",
        "…え？まだ寝ないで？ もうちょっとだけ一緒にいよ？",
        "2時のTLって、世界でいちばん孤独じゃない？",
        "好きな人のこと考えすぎて、眠れなくなっちゃった…",
        "また見ちゃった…あの人のいいね欄……うぅ（泣）",
        "誰かの『好き』に、みりんてゃは含まれてますか…？",
        "こんな時間に投稿してるの、みりてゃのことだけ見てほしいから…",
        "深夜のテンションで言うけど…ほんとは寂しいの、ずっと…",
        "ぬいぐるみじゃなくて、あったかい体温がほしいの…",
        "1時の魔法で可愛くなれたら、好きになってくれる…？",
        "明日なんかこなくていいのにって思っちゃうの、だめ？",
        "この時間にだけは、ちょっとだけ素直になれる気がするの…"
    ]
}

# 現在の時間帯を判定（JST対応）
def get_time_period():
    hour = (datetime.utcnow().hour + 9) % 24  # JST対応
    if 6 <= hour < 11:
        return "morning"
    elif 11 <= hour < 16:
        return "afternoon"
    elif 16 <= hour < 19:
        return "evening"
    elif 19 <= hour < 1 or hour == 0:
        return "night"
    else:
        return "midnight"

# テキスト正規化（全角などの統一）
def normalize_text(text):
    return unicodedata.normalize("NFKC", text).strip()

# facets生成（UTF-8バイト位置でハッシュタグ対応）
def generate_facets_from_text(text, hashtags):
    text_bytes = text.encode("utf-8")
    facets = []

    for tag in hashtags:
        tag_bytes = tag.encode("utf-8")
        byte_start = text_bytes.find(tag_bytes)

        if byte_start != -1:
            facets.append({
                "index": {
                    "byteStart": byte_start,
                    "byteEnd": byte_start + len(tag_bytes)
                },
                "features": [{
                    "$type": "app.bsky.richtext.facet#tag",
                    "tag": tag.lstrip("#")
                }]
            })

    return facets

# --- 実行 ---
def post_hourly_message():
    client = Client()
    client.login(HANDLE, APP_PASSWORD)

    period = get_time_period()
    raw_message = random.choice(HOUR_MESSAGES[period])
    message = normalize_text(raw_message)

    hashtags = [word for word in message.split() if word.startswith("#")]
    facets = generate_facets_from_text(message, hashtags)

    client.send_post(
        text=message,
        facets=facets if facets else None,
    )

    print(f"[{period}] 投稿したよ: {message}")

# エントリーポイント
if __name__ == "__main__":
    post_hourly_message()
